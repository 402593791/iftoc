#!/usr/bin/env ruby

require 'optparse'
require 'rexml/document'
require 'iftoc'

$inpath = ARGV[0]
$outpath = Dir::pwd

$helpString = <<-EOB
Usage: iftoc <svgfile | cssfile> [--out <outpath>]
EOB

def paramCheck

  OptionParser.new do |opts|
    opts.banner = $helpString
    opts.on("-o", "--out <outpath>", String) do |value|
      $outpath = value
    end
  end.parse!

  if ARGV.count < 1 then
    puts $helpString
    exit(1)
  end

  if !File.exist?($inpath) then
    puts "No such file: " + $inpath
    exit(1)
  end

  if !File.exist?($outpath) then
    puts "No such directory: " + $outpath
    exit(1)
  end

end

def parseSVGFontName(xmlContext)
  fontelement = xmlContext.root.elements["defs"].elements["font"]
  return fontelement.elements["font-face"].attributes["font-family"]
end

def parseSVGIconFont(xmlContext)
  iconfonts = Hash.new
  fontelement = xmlContext.root.elements["defs"].elements["font"]
  fontelement.get_elements("glyph").each { |font|
    name = font.attributes["glyph-name"]
    unicode = font.attributes["unicode"].to_s.delete("#x;")
    if unicode.length == 4 then
      iconfonts[name] = unicode
    end
  }
  return iconfonts
end

# main
paramCheck

io = File.open($inpath)
doc = REXML::Document.new(io.read.to_s.delete("&"))
if doc.root then
  iconfontName = parseSVGFontName(doc)
  iconfontMap = parseSVGIconFont(doc)
else
  io.close
  io = File.open($inpath)
  iconfontName = Iftoc.parseCSSFontName(io)
  iconfontMap = Iftoc.parseCSSIconFont(io)
end
io.close

# exception
if !iconfontName || iconfontMap.count < 1 then
  print("parse error! ")
  exit(1)
end

# hfile
hfilepath = $outpath+"/Iconfont.h"
Iftoc.putStringToFile(Iftoc.generateHFile(iconfontMap), hfilepath)

# mfile
mfilepath = $outpath+"/Iconfont.m"
Iftoc.putStringToFile(Iftoc.generateMFile(iconfontName, iconfontMap), mfilepath)

puts "Done!"






